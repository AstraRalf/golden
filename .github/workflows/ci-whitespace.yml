name: ci-whitespace
on:
  push:
    branches: ['**']
  pull_request:
  workflow_dispatch:
concurrency:
  group: ci-whitespace-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Whitespace/EOL checks (PowerShell)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $files = (git ls-files) -split "`n"
          $errors = New-Object System.Collections.Generic.List[string]
          foreach($f in $files){
            if([string]::IsNullOrWhiteSpace($f) -or -not (Test-Path -LiteralPath $f)){ continue }
            try {
              $bytes = [System.IO.File]::ReadAllBytes($f)
              if($bytes -contains 13){ $errors.Add("CR found: $f") }
              $text = Get-Content -LiteralPath $f -Raw -Encoding UTF8
              $lines = $text -split "`n",-1
              for($i=0; $i -lt $lines.Count; $i++){
                $line = $lines[$i]
                if($line -match "`t"){ $errors.Add("$f:$([int]($i+1)): TAB") }
                if($line -match "\s+$"){
                  if($f -match '\.(md|markdown)$'){
                    $m = [regex]::Match($line,'(\s+)$'); $n = $m.Groups[1].Value.Length
                    if($n -eq 2) { } elseif($n -gt 2) { $errors.Add("$f:$([int]($i+1)): trailing spaces ($n)") }
                    else { $errors.Add("$f:$([int]($i+1)): trailing space") }
                  } else {
                    $errors.Add("$f:$([int]($i+1)): trailing whitespace")
                  }
                }
              }
              if(-not $text.EndsWith("`n")){ $errors.Add("$f: missing final newline") }
            } catch { $errors.Add("$f: read error") }
          }
          if($errors.Count -gt 0){
            "Whitespace issues:`n" + ($errors -join "`n") | Write-Output
            exit 1
          }
          "OK"
