name: FAB7 CI
on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
jobs:
  lint_and_smoke:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Whitespace/EOL check (diff-only, non-fatal)
        shell: pwsh
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          git --no-pager diff --check origin/${{ github.base_ref }}...HEAD; exit 0
      - name: UXLegal advisory lint (diff-only + waivers)
        shell: pwsh
        run: pwsh -NoLogo -File policy/uxlegal/ci_lint.ps1
      - name: Sandbox smoke
        shell: pwsh
        run: pwsh -NoLogo -File sandbox/harness/smoke.ps1
      - name: Scenario DSL runner (Nash + others)
        shell: pwsh
        run: pwsh -NoLogo -File sandbox/harness/run_scenarios.ps1

      - name: Capture Step Summary
        if: always()
        shell: bash
        run: |
          cp "\" scenario-summary.md || true

      - name: Upload Scenario Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scenario-summary
          path: scenario-summary.md
          if-no-files-found: warn
          retention-days: 14

      - name: Upload Nash Outputs (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nash-outputs
          path: |
            step16_nash/ci_out_latest/*.txt
            step16_nash/ci_out_latest/*.json
          if-no-files-found: ignore
          retention-days: 14
