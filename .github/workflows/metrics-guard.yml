name: Metrics Guard (Step16)


defaults:
  run:
shell: pwsh
on:
  pull_request::
  workflow_dispatch:
    types: [opened, synchronize, reopened, labeled, unlabeled, edited]
    paths:
      - ".github/workflows/step16-nash.yml"

permissions:
  contents: read
  pull-requests: read

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # Pr├╝fe, ob sich die erwarteten Metrik-Zeilen im step16-Workflow ge├ñndert haben
      - id: diff
        name: Detect expectation changes in step16-nash.yml
        
defaults:
  run:
    shell: pwshshell: bash
        run: |
          set -e
          file=".github/workflows/step16-nash.yml"
          if ! git rev-parse HEAD^ >/dev/null 2>&1; then
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          if git diff -U0 HEAD^ HEAD -- "$file" | grep -E "PoA_(util|cost) expected|should be null" >/dev/null; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # Labels direkt aus dem Event-Kontext (ohne gh)
      - id: labels
        name: Read labels from PR event
        
defaults:
  run:
    shell: pwshuses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request?.labels || []).map(l => l.name);
            core.info(`Labels: ${labels.join(', ')}`);
            core.setOutput('labels', labels.join('\n'));

      - name: Show diagnostics
        run: |
          echo "changed=${{ steps.diff.outputs.changed }}"
          printf "labels:\n%s\n" "${{ steps.labels.outputs.labels }}"

      # Fail NUR wenn Metrik-Erwartungen ge├ñndert wurden UND das Label fehlt
      - name: Enforce metrics-update label
        if: ${{ steps.diff.outputs.changed == 'true' && !contains(steps.labels.outputs.labels, 'metrics-update') }}
        run: |
          echo "::error::Metrics expectations changed but PR lacks 'metrics-update' label."
          exit 1

