name: FAB7 Verify README & SHA
on:
  workflow_dispatch:
  repository_dispatch:
    types: [fab7-verify]

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Check README block vs latest release SHA
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          $ErrorActionPreference = 'Stop'
          $headers = @{ Authorization = "Bearer $env:GH_TOKEN"; "User-Agent"="fab7-verify"; "Accept"="application/vnd.github+json" }

          $rel = Invoke-RestMethod -Uri "https://api.github.com/repos/$env:REPO/releases/latest" -Headers $headers
          $shaAsset = $rel.assets | Where-Object name -like 'Llama-FAB7-PACK-*.zip.sha256' | Select-Object -First 1
          if(-not $shaAsset){ throw "No .sha256 asset found" }
          $shaText = Invoke-RestMethod -Uri $shaAsset.browser_download_url -Headers $headers -Method Get
          if($shaText -notmatch '([0-9a-fA-F]{64})'){ throw "Invalid .sha256 content" }
          $zipSha = $Matches[1].ToLower()

          $rd = Invoke-RestMethod -Uri "https://api.github.com/repos/$env:REPO/contents/README.md" -Headers $headers -Method Get
          $txt = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String(($rd.content -replace '\s','')))
          $m = [regex]::Match($txt,'<!--\s*FAB7_PACK_START\s*-->.*?([0-9a-fA-F]{64}).*?<!--\s*FAB7_PACK_END\s*-->','Singleline')
          if(-not $m.Success){ throw "FAB7 block missing in README" }
          $readmeSha = $m.Groups[1].Value.ToLower()

          if($zipSha -ne $readmeSha){
            Write-Error "Mismatch: release=$zipSha README=$readmeSha"
          } else {
            "OK: SHA matches"
          }
