name: FAB7 Verify README & SHA

defaults:
  run:
    shell: pwshon:
  workflow_dispatch:
  repository_dispatch:
    types: [fab7-verify]

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Check README block vs pack-* release SHA (robust; SKIP wenn nicht m√∂glich)
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          $ErrorActionPreference = 'Stop'
          $headers = @{ Authorization = "Bearer $env:GH_TOKEN"; "User-Agent"="fab7-verify"; "Accept"="application/vnd.github+json" }

          function Get-PackRelease {
            try {
              $rels = Invoke-RestMethod -Uri "https://api.github.com/repos/$env:REPO/releases?per_page=30" -Headers $headers -Method Get
              if(-not $rels){ return $null }
              foreach($r in $rels){
                if($r.tag_name -like 'pack-*'){
                  $s = $r.assets | Where-Object name -like 'Llama-FAB7-PACK-*.zip.sha256' | Select-Object -First 1
                  if($s){ return $r }
                }
              }
              return $null
            } catch { return $null }
          }

          $rel = Get-PackRelease
          if(-not $rel){ "SKIP: kein passendes pack-* Release"; exit 0 }

          $shaAsset = $rel.assets | Where-Object name -like 'Llama-FAB7-PACK-*.zip.sha256' | Select-Object -First 1
          if(-not $shaAsset){ "SKIP: .sha256 Asset fehlt"; exit 0 }

          $shaText = Invoke-RestMethod -Uri $shaAsset.browser_download_url -Headers $headers -Method Get
          if($shaText -notmatch '([0-9a-fA-F]{64})'){ "SKIP: .sha256 unlesbar"; exit 0 }
          $zipSha = $Matches[1].ToLower()

          $rd = Invoke-RestMethod -Uri "https://api.github.com/repos/$env:REPO/contents/README.md" -Headers $headers -Method Get
          $txt = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String(($rd.content -replace '\s','')))
          $m = [regex]::Match($txt,'<!--\s*FAB7_PACK_START\s*-->.*?([0-9a-fA-F]{64}).*?<!--\s*FAB7_PACK_END\s*-->','Singleline')
          if(-not $m.Success){ "SKIP: FAB7-Block fehlt"; exit 0 }

          $readmeSha = $m.Groups[1].Value.ToLower()
          if($zipSha -ne $readmeSha){
            Write-Error "Mismatch: release=$zipSha README=$readmeSha"
          } else {
            "OK: SHA matches"
          }

