#!/usr/bin/env bash
set -euo pipefail

MAX=10485760  # 10MB

# Liste der gestagten Dateien (null-separiert)
mapfile -d '' files < <(git diff --cached --name-only -z)

# 1) Größencheck (alle Dateien)
for f in "${files[@]}"; do
  [ -f "$f" ] || continue
  sz=$(wc -c <"$f")
  if [ "$sz" -gt "$MAX" ]; then
    echo "❌ File too large (>10MB): $f ($sz bytes)" >&2
    exit 1
  fi
done

# 2) Trailing whitespace
if ! git diff --cached --check --color=never; then
  echo "❌ Trailing whitespace gefunden. Bitte fixen und erneut committen." >&2
  exit 1
fi

# 3) Secret-Scan: nur hinzugefügte Zeilen, und .githooks/** ausnehmen
for f in "${files[@]}"; do
  # .githooks ausschließen
  case "$f" in
    .githooks/*) continue ;;
  esac

  # Nur +Zeilen der Datei scannen
  if git diff --cached -U0 -- "$f" | grep -E '^\+' | grep -Eiq \
    'AKIA[0-9A-Z]{16}|aws_secret_access_key|BEGIN (RSA|OPENSSH) PRIVATE KEY|password\s*='; then
    echo "❌ Mögliche Secrets in: $f" >&2
    exit 1
  fi
done

exit 0